# Multi-Region Inference Orchestrator

å¤š Region Spot GPU å¼‚æ­¥æ¨ç†ç¼–æ’ç³»ç»Ÿ

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº AWS çš„æ™ºèƒ½é˜Ÿåˆ—åˆ†å‘ç³»ç»Ÿï¼Œé€šè¿‡ Lambda å‡½æ•°å®ç°è·¨å¤šä¸ª AWS Region çš„å¼‚æ­¥æ¨ç†è¯·æ±‚ç¼–æ’ã€‚ç³»ç»Ÿæ—¨åœ¨çªç ´å•ä¸ª Region Spot GPU æ•°é‡é™åˆ¶ï¼Œå……åˆ†åˆ©ç”¨å¤šåŒºåŸŸèµ„æºï¼Œæé«˜æ¨ç†ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œååé‡ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸŒ **å¤š Region åˆ†å‘**ï¼šæ™ºèƒ½è°ƒåº¦è¯·æ±‚åˆ°å¤šä¸ª AWS Region
- ğŸ“Š **è´Ÿè½½æ„ŸçŸ¥**ï¼šåŸºäºé˜Ÿåˆ—æ·±åº¦çš„åå‘æƒé‡ç®—æ³•
- ğŸ”’ **å¹‚ç­‰æ€§ä¿éšœ**ï¼šDynamoDB å®ç°çš„è¯·æ±‚å»é‡æœºåˆ¶
- âš¡ **æ‰¹é‡å¤„ç†**ï¼šé«˜æ•ˆçš„æ¶ˆæ¯æ‰¹é‡è½¬å‘
- ğŸ”„ **è‡ªåŠ¨é‡è¯•**ï¼šSQS åŸç”Ÿçš„æ¶ˆæ¯å¯è§æ€§å’Œ DLQ æœºåˆ¶

## ç³»ç»Ÿæ¶æ„

```
å®¢æˆ·ç«¯åº”ç”¨
    â†“
æ€»é˜Ÿåˆ— (Master SQS)
    â†“
åˆ†å‘ Lambda Function
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Region1    Region2    Region3
SQSé˜Ÿåˆ—    SQSé˜Ÿåˆ—    SQSé˜Ÿåˆ—
    â†“          â†“          â†“
EKSé›†ç¾¤    EKSé›†ç¾¤    EKSé›†ç¾¤
```

### æ ¸å¿ƒç»„ä»¶

- **æ€»é˜Ÿåˆ— (Master SQS)**: ç»Ÿä¸€çš„æ¨ç†è¯·æ±‚å…¥å£
- **åˆ†å‘ Lambda**: è´Ÿè½½æ„ŸçŸ¥çš„æ™ºèƒ½è°ƒåº¦å™¨
- **åŒºåŸŸå­é˜Ÿåˆ—**: å„ Region ç‹¬ç«‹çš„ SQS é˜Ÿåˆ—
- **å¹‚ç­‰æ€§è¡¨ (DynamoDB)**: é˜²æ­¢æ¶ˆæ¯é‡å¤å¤„ç†

## é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lambda/
â”‚   â”‚   â””â”€â”€ distributor/          # åˆ†å‘ Lambda å‡½æ•°
â”‚   â”‚       â”œâ”€â”€ handler.py        # Lambda å…¥å£
â”‚   â”‚       â”œâ”€â”€ queue_selector.py # é˜Ÿåˆ—é€‰æ‹©é€»è¾‘
â”‚   â”‚       â”œâ”€â”€ idempotency.py    # å¹‚ç­‰æ€§æ£€æŸ¥
â”‚   â”‚       â””â”€â”€ config.py         # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ common/                   # å…¬å…±å·¥å…·
â”‚       â”œâ”€â”€ sqs_client.py
â”‚       â””â”€â”€ dynamodb_client.py
â”œâ”€â”€ infrastructure/               # IaC ä»£ç  (SAM/CDK)
â”‚   â”œâ”€â”€ template.yaml            # SAM æ¨¡æ¿
â”‚   â””â”€â”€ cdk/                     # æˆ–ä½¿ç”¨ CDK
â”œâ”€â”€ tests/                       # å•å…ƒæµ‹è¯•
â””â”€â”€ tasks/                       # ä»»åŠ¡è·Ÿè¸ª
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python 3.12+
- AWS CLI (é…ç½®å¥½ credentials)
- SAM CLI æˆ– AWS CDK
- pytest (ç”¨äºæµ‹è¯•)

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### æœ¬åœ°æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/

# SAM æœ¬åœ°è°ƒç”¨
sam local invoke DistributorFunction --event events/sample-sqs-event.json
```

## éƒ¨ç½²

### ä½¿ç”¨ SAM

```bash
# æ„å»º
sam build

# éƒ¨ç½²
sam deploy --guided --profile default
```

### ä½¿ç”¨ CDK

```bash
# åˆæˆ CloudFormation æ¨¡æ¿
cdk synth --profile default

# éƒ¨ç½²
cdk deploy --all --profile default
```

## é…ç½®å‚æ•°

### Lambda é…ç½®
- **è¿è¡Œæ—¶**: Python 3.12
- **è¶…æ—¶**: 300 ç§’
- **å†…å­˜**: 512 MB
- **å¹¶å‘é™åˆ¶**: 100

### é˜Ÿåˆ—é…ç½®
- **æ€»é˜Ÿåˆ— VisibilityTimeout**: 600 ç§’
- **å­é˜Ÿåˆ— VisibilityTimeout**: 3600 ç§’
- **é‡è¯•æ¬¡æ•°**: 3 æ¬¡åè¿›å…¥ DLQ

### åˆ†å‘ç®—æ³•
- **è´Ÿè½½ç¼“å­˜ TTL**: 60 ç§’
- **é˜Ÿåˆ—è¿‡è½½é˜ˆå€¼**: 5000 æ¡æ¶ˆæ¯
- **æƒé‡ç®—æ³•**: åå‘æƒé‡ï¼ˆè´Ÿè½½è¶Šä½ï¼Œæƒé‡è¶Šé«˜ï¼‰

## æ¶ˆæ¯æ ¼å¼

```json
{
  "request_id": "req-12345-uuid",
  "model_name": "gpt-l-7b",
  "input_data_url": "s3://bucket/inputs/req-12345.json",
  "callback_sns_topic": "arn:aws:sns:us-east-1:xxx:inference-results",
  "priority": "high",
  "timestamp": "2025-12-02T10:23:00Z",
  "metadata": {
    "user_id": "user123",
    "session_id": "session456"
  }
}
```

## ç›‘æ§

å…³é”® CloudWatch æŒ‡æ ‡ï¼š
- Lambda è°ƒç”¨æ¬¡æ•°ã€é”™è¯¯ç‡ã€æŒç»­æ—¶é—´
- SQS é˜Ÿåˆ—æ·±åº¦ï¼ˆæ€»é˜Ÿåˆ— + å„å­é˜Ÿåˆ—ï¼‰
- DynamoDB å†™å…¥å»¶è¿Ÿ
- DLQ æ¶ˆæ¯æ•°

## æˆæœ¬ä¼˜åŒ–

- âœ… ä½¿ç”¨è´Ÿè½½ç¼“å­˜å‡å°‘ SQS API è°ƒç”¨
- âœ… Lambda å¹¶å‘æ§åˆ¶é¿å…è¿‡åº¦è°ƒç”¨
- âœ… DynamoDB TTL è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- âœ… å­é˜Ÿåˆ—ä½¿ç”¨é•¿è½®è¯¢é™ä½ç©ºè¯·æ±‚æˆæœ¬

## License

MIT License
